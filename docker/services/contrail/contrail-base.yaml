heat_template_version: queens

description: >
  Base parameters for all Contrail Services.

parameters:
  ServiceData:
    default: {}
    description: Dictionary packing service data
    type: json
  ServiceNetMap:
    default: {}
    description: Mapping of service_name -> network name. Typically set
                 via parameter_defaults in the resource registry.  This
                 mapping overrides those in ServiceNetMapDefaults.
    type: json
  DefaultPasswords:
    default: {}
    type: json
  RoleName:
    default: ''
    description: Role name on which the service is applied
    type: string
  RoleParameters:
    default: {}
    description: Parameters specific to the role
    type: json
  EndpointMap:
    default: {}
    description: Mapping of service endpoint -> protocol. Typically set
                 via parameter_defaults in the resource registry.
    type: json
  AdminPassword:
    description: The password for the keystone admin account, used for monitoring, querying neutron etc.
    type: string
    hidden: true
  AdminTenantName:
    description: Keystone admin tenant name
    type: string
    default: 'admin'
  AdminUser:
    description: Keystone admin user name
    type: string
    default: 'admin'
  KeystoneProjectDomainName:
    type: string
    default: 'Default'
    description: Keystone Project Domain Name
  KeystoneRegion:
    type: string
    default: 'regionOne'
    description: Keystone region for endpoint
  KeystoneUserDomainName:
    type: string
    default: 'Default'
    description: Keystone User Domain Name
  AAAMode:
    description: AAAmode can be no-auth, cloud-admin or rbac
    type: string
    default: 'cloud-admin'
  ContrailAnalyticsVIP:
    default: ''
    description: >
      Contrail Analytics Api address (optional). 
      In might be set to a virtual IP if a particular specific IP is needed.
      In case of RedHat IDM and TLS everwhere it cannot be IP and should be an FQDN.
    type: string
  ContrailConfigVIP:
    default: ''
    description: >
      Contrail Config Api address (optional). 
      By default it is the name of ContrailConfig network.
      In might be set to a virtual IP if a particular specific IP is needed.
      In case of RedHat IDM and TLS everwhere it cannot be IP and should be an FQDN.
      It is used to configure Heat & Neutron Contrail Plugins on Openstack controller nodes.
    type: string
  ContrailWebuiVIP:
    default: ''
    description: >
      Contrail Webui address (optional). 
      In might be set to a virtual IP if a particular specific IP is needed.
      In case of RedHat IDM and TLS everwhere it cannot be IP and should be an FQDN.
    type: string
  ContrailRegistry:
    default: 'opencontrailnightly'
    description: Contrail Registry
    type: string
  ContrailSettings:
    default: {}
    description: Contrail Service settings
    type: json
  ContrailImageTag:
    default: 'latest'
    description: Contrail container image tag
    type: string
  DockerContrailNodemgrImageName:
    description: image
    type: string
    default: "contrail-nodemgr"
  SSLCertificate:
    default: ''
    description: >
      The content of the SSL certificate (without Key) in PEM format.
    type: string
  PublicSSLCertificateAutogenerated:
    default: false
    description: >
      Whether the public SSL certificate was autogenerated or not.
    type: boolean
  DeployedSSLCertificatePath:
    default: '/etc/pki/tls/private/overcloud_endpoint.pem'
    description: >
        The filepath of the certificate as it will be stored in the controller.
    type: string
  EnableInternalTLS:
    type: boolean
    default: false
  CertmongerCA:
    type: string
    default: 'IPA'
  InternalTLSCAFile:
    default: '/etc/ipa/ca.crt'
    type: string
    description: Specifies the default CA cert to use if TLS is used for
                 services in the internal network.
  InternalTLSCRLPEMFile:
    default: '/etc/pki/CA/crl/overcloud-crl.pem'
    type: string
    description: Specifies the default CRL PEM file to use for revocation if
                 TLS is used for services in the internal network.
  ContrailCA:
    default: ''
    description: Contrail CA, could be local or IPA
    type: string
  ContrailSslEnabled:
    description:  Flag to identify is SSL should be used in internal Contrail
                  services communications (sandesh, introspect, xmpp, ..).
    type: boolean
    default: false
  ContrailServiceCertFile:
    description: Path to the node's public certificate
    type: string
    default: ''
  ContrailServiceKeyFile:
    description: Path to server's/node's private key
    type: string
    default: ''
  ContrailCaCertFile:
    default: ''
    description: Path to CA certificate
    type: string
  ContrailCaKeyFile:
    default: ''
    description: Path to CA private key
    type: string
  ContrailRedisPort:
    default: 6379
    description: Contrail Redis port
    type: number
  NodeDataLookup:
    type: json
    default: {}
    description: json containing per-node configuration map
  # internal params
  contrail_nodes_param_suffux:
    type: string
    default: "node_ips"
    description: suffix for reading hiera data, node_ips or node_names

conditions:
  is_not_5_0:
    not: 
      yaql:
        expression: $.data.split(":")[-1].matches("5\.0")
        data: {get_param: ContrailImageTag}
  contrail_config_vip_unset: {equals : [{get_param: ContrailConfigVIP}, '']}
  contrail_analytics_vip_unset: {equals : [{get_param: ContrailAnalyticsVIP}, '']}
  contrail_webui_vip_unset: {equals : [{get_param: ContrailWebuiVIP}, '']}
  public_tls_enabled:
    or:
      - not: {equals: [{get_param: SSLCertificate}, '']}
      - {equals: [{get_param: PublicSSLCertificateAutogenerated}, true]}
  internal_tls_enabled: {equals: [{get_param: EnableInternalTLS}, true]}
  internal_ipa_ca: {equals: [{get_param: CertmongerCA}, 'IPA']}
  contrail_tls_enabled: {equals: [{get_param: ContrailSslEnabled}, true]}
  contrail_ipa_ca: {equals: [{get_param: ContrailCA}, 'IPA']}
  bind_contrail_ca_file:
    and:
      - contrail_tls_enabled
      - contrail_ipa_ca
      - or:
        - not: internal_tls_enabled
        - not: {equals: [{get_param: ContrailCaCertFile}, {get_param: InternalTLSCAFile}]}
  set_auth_ca_file:
    and:
      - internal_tls_enabled
      - internal_ipa_ca
  haproxy_verify_host:
    and:
      - internal_tls_enabled
      - internal_ipa_ca
      - contrail_tls_enabled
      - contrail_ipa_ca
      - {equals: [{get_param: ContrailCaCertFile}, {get_param: InternalTLSCAFile}]}

  contrail_api_ssl_enabled:
    and:
      - is_not_5_0
      - contrail_tls_enabled

  # tripleo-heat-templates/docker/services/haproxy.yaml:
  # NOTE(jaosorior): We disable the CRL since we have no way to restart haproxy
  # when this is updated
  haproxy_crl_file: false
  # haproxy_crl_file:
  #   not: {equals: [{get_param: InternalTLSCRLPEMFile}, '']}

resources:
  ContainersCommon:
    type: ../containers-common.yaml

  # Merging role-specific parameters (RoleParameters) with the default parameters.
  # RoleParameters will have the precedence over the default parameters.
  RoleParametersValue:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        map_replace:
          - map_replace:
            - contrail_settings: ContrailSettings
              contrail::aaa_mode: AAAMode
            - values: {get_param: [RoleParameters]}
          - values:
              ContrailSettings: {get_param: ContrailSettings}
              AAAMode: {get_param: AAAMode}

  ContrailNodemgrImageNormalize:
    type: ../../../tools/contrail/contrail-image-normalize.yaml
    properties:
      GenericImageName: {get_param: DockerContrailNodemgrImageName}

outputs:
  role_data:
    description: Shared role data for the Contrail services.
    value:
      contrail_nodemgr_image_name: {get_attr: [ContrailNodemgrImageNormalize, contrail_image]}
      config_settings:
        map_merge:
        - contrail::admin_password: {get_param: AdminPassword}
          contrail::admin_tenant_name: {get_param: AdminTenantName}
          contrail::admin_user: {get_param: AdminUser}
          # ==
          # for puppets: neutron_plugin.pp and heat.pp
          # todo: remove admin_token after puppet update
          contrail::admin_token: ''
          contrail::auth_host: {get_param: [EndpointMap, KeystoneAdmin, host] }
          contrail::auth_port: {get_param: [EndpointMap, KeystoneAdmin, port] }
          contrail::auth_protocol: {get_param: [EndpointMap, KeystoneAdmin, protocol] }
          contrail::api_port: '8082'
          contrail::keystone_region: {get_param: KeystoneRegion}
          contrail::keystone_project_domain_name: {get_param: KeystoneProjectDomainName}
          contrail::keystone_user_domain_name: {get_param: KeystoneUserDomainName}
          contrail_internal_api_ssl: {get_param: EnableInternalTLS}
          contrail_ssl_enabled: {get_param: ContrailSslEnabled}
          # ==
          node_data_lookup: {get_param: NodeDataLookup}
        - get_attr: [RoleParametersValue, value]
        - if:
          - contrail_config_vip_unset
          - contrail_config_vip:
              str_replace:
                template:
                  "%{hiera('cloud_name_$NETWORK')}"
                params:
                  $NETWORK: {get_param: [ServiceNetMap, ContrailConfigNetwork]}
          - contrail_config_vip: {get_param: ContrailConfigVIP}
        - if:
          - contrail_webui_vip_unset
          - contrail_webui_vip:
              str_replace:
                template:
                  "%{hiera('cloud_name_$NETWORK')}"
                params:
                  $NETWORK: {get_param: [ServiceNetMap, ContrailWebuiNetwork]}
          - contrail_webui_vip: {get_param: ContrailWebuiVIP}
        - if:
          - contrail_analytics_vip_unset
          - contrail_analytics_vip:
              str_replace:
                template:
                  "%{hiera('cloud_name_$NETWORK')}"
                params:
                  $NETWORK: {get_param: [ServiceNetMap, ContrailAnalyticsNetwork]}
          - contrail_analytics_vip: {get_param: ContrailAnalyticsVIP}
        - if:
          - set_auth_ca_file
          - contrail::auth_ca_file: {get_param: InternalTLSCAFile}
          - null
      haproxy_config_settings_member_options: &haproxy_config_settings_member_options
          - 'check'
          - 'inter 2000'
          - 'rise 2'
          - 'fall 5'
      haproxy_config_settings_member_options_tls: &haproxy_config_settings_member_options_tls
        list_concat:
          - *haproxy_config_settings_member_options
          - - 'ssl'
          - if:
            - haproxy_verify_host
            - list_concat:
              - - 'verify required'
                - list_join:
                  - ' '
                  - - 'ca-file'
                    - {get_param: InternalTLSCAFile}
              - if:
                - haproxy_crl_file
                - - list_join:
                    - ' '
                    - - 'crl-file'
                      - {get_param: InternalTLSCRLPEMFile}
                - null
            - - 'verify none'
      haproxy_config_settings_listen_options: &haproxy_config_settings_listen_options
        balance:
          - 'source'
        hash-type:
          - 'consistent'
      haproxy_config_settings: &haproxy_config_settings
        public_virtual_ip: "%{hiera('public_virtual_ip')}"
        mode: 'http'
        listen_options:
          map_merge:
            - *haproxy_config_settings_listen_options
            - option:
                - 'httpchk GET /'
                - 'httplog'
                - 'forwardfor'
              http-request:
                - 'set-header X-Forwarded-Proto https if { ssl_fc }'
                - 'set-header X-Forwarded-Proto http if !{ ssl_fc }'
        # TODO: use this section as RedHat port the commit from upstream quuens:
        #   commit 47ec9ce49b0a9e26701f63c9841ab2f982f7af32
        #   Author: Andrew Austin <aaustin@redhat.com>
        #   Date:   Thu Jun 21 22:08:51 2018 +0000
        #    Add mechanism for cookie-based sessions in endpoints.
        # --
        # sticky_sessions: true
        # session_cookie: 'SERVERID'
        # listen_options:
        #   balance:
        #     - 'roundrobin'
        #   option:
        #     - 'forwardfor'
        #   http-request:
        #     - 'set-header X-Forwarded-Proto https if { ssl_fc }'
        #     - 'set-header X-Forwarded-Proto http if !{ ssl_fc }'
        member_options: *haproxy_config_settings_member_options
      haproxy_config_settings_tls: &haproxy_config_settings_tls
        map_merge:
          - *haproxy_config_settings
          - member_options: *haproxy_config_settings_member_options_tls
      haproxy_config_settings_api: &haproxy_config_settings_api
        if:
          - contrail_api_ssl_enabled
          - *haproxy_config_settings_tls
          - *haproxy_config_settings
      haproxy_config_settings_webui: &haproxy_config_settings_webui
        if:
          - public_tls_enabled
          - *haproxy_config_settings_tls
          - public_virtual_ip: "%{hiera('public_virtual_ip')}"
            mode: 'tcp'
            listen_options: *haproxy_config_settings_listen_options
            member_options: *haproxy_config_settings_member_options
      contrail_base_volumes: &contrail_base_volumes
        list_concat:
          - {get_attr: [ContainersCommon, volumes]}
          - - /etc/contrail/ssl:/etc/contrail/ssl
            - /var/crashes:/var/crashes
            - /var/log/containers/contrail:/var/log/contrail
          - if:
            - bind_contrail_ca_file
            - - list_join:
                - ':'
                - - {get_param: ContrailCaCertFile}
                  - {get_param: ContrailCaCertFile}
                  - 'ro'
            - null
      contrail_general_base_env: &contrail_general_base_env
        - 'CLOUD_ORCHESTRATOR=openstack'
        - 'OPENSTACK_VERSION=queens'
        - list_join:
          - '='
          - - 'AAA_MODE'
            - {get_attr: [RoleParametersValue, value, 'contrail::aaa_mode']}
        - str_replace:
            template: REDIS_SERVER_PORT=_REDIS_SERVER_PORT_
            params:
              _REDIS_SERVER_PORT_: {get_param: ContrailRedisPort}
      contrail_auth_base_env: &contrail_auth_base_env
        - 'AUTH_MODE=keystone'
        - 'KEYSTONE_AUTH_URL_VERSION=/v3'
        - list_join:
          - '='
          - - 'KEYSTONE_AUTH_ADMIN_PASSWORD'
            - {get_param: AdminPassword}
        - list_join:
          - '='
          - - 'KEYSTONE_AUTH_ADMIN_USER'
            - {get_param: AdminUser}
        - list_join:
          - '='
          - - 'KEYSTONE_AUTH_ADMIN_TENANT'
            - {get_param: AdminTenantName}
        - list_join:
          - '='
          - - 'KEYSTONE_AUTH_REGION_NAME'
            - {get_param: KeystoneRegion}
        - list_join:
          - '='
          - - 'KEYSTONE_AUTH_PROJECT_DOMAIN_NAME'
            - {get_param: KeystoneProjectDomainName}
        - list_join:
          - '='
          - - 'KEYSTONE_AUTH_USER_DOMAIN_NAME'
            - {get_param: KeystoneUserDomainName}
      contrail_auth_admin_env: &contrail_auth_admin_env
        - list_join:
          - '='
          - - 'KEYSTONE_AUTH_HOST'
            - {get_param: [EndpointMap, KeystoneAdmin, host] }
        - list_join:
          - '='
          - - 'KEYSTONE_AUTH_ADMIN_PORT'
            - {get_param: [EndpointMap, KeystoneAdmin, port] }
        - list_join:
          - '='
          - - 'KEYSTONE_AUTH_PROTO'
            - {get_param: [EndpointMap, KeystoneAdmin, protocol] }
      contrail_auth_internal_env: &contrail_auth_internal_env
        - list_join:
          - '='
          - - 'KEYSTONE_AUTH_HOST'
            - {get_param: [EndpointMap, KeystoneInternal, host] }
        - list_join:
          - '='
          - - 'KEYSTONE_AUTH_ADMIN_PORT'
            - {get_param: [EndpointMap, KeystoneInternal, port] }
        - list_join:
          - '='
          - - 'KEYSTONE_AUTH_PROTO'
            - {get_param: [EndpointMap, KeystoneInternal, protocol] }
      contrail_tls_env: &contrail_tls_env
        if:
          - contrail_tls_enabled
          - list_concat:
              - - "SSL_ENABLE=True"
                - "XMPP_SSL_ENABLE=True"
                - "SANDESH_SSL_ENABLE=True"
                - "INTROSPECT_SSL_ENABLE=True"
                - if:
                  - contrail_ipa_ca
                  - 'INTROSPECT_SSL_INSECURE=False'
                  - 'INTROSPECT_SSL_INSECURE=True'
                - list_join:
                    - '='
                    - - 'SERVER_CERTFILE'
                      - {get_param: ContrailServiceCertFile}
                - list_join:
                    - '='
                    - - 'SERVER_KEYFILE'
                      - {get_param: ContrailServiceKeyFile}
                - list_join:
                    - '='
                    - - 'SERVER_CA_CERTFILE'
                      - {get_param: ContrailCaCertFile}
                - list_join:
                    - '='
                    - - 'SERVER_CA_KEYFILE'
                      - {get_param: ContrailCaKeyFile}
              - if:
                  - is_not_5_0
                  - - "KAFKA_SSL_ENABLE=True"
                    - "CASSANDRA_SSL_ENABLE=True"
                    - "RABBITMQ_USE_SSL=True"
                  - - "KAFKA_SSL_ENABLE=False"
                    - "CASSANDRA_SSL_ENABLE=False"
                    - "RABBITMQ_USE_SSL=False"

          - []
      contrail_auth_tls_env: &contrail_auth_tls_env
        if:
          - internal_tls_enabled
          - list_concat:
              - - list_join:
                    - '='
                    - - 'KEYSTONE_AUTH_CERTFILE'
                      - {get_param: ContrailServiceCertFile}
                - list_join:
                    - '='
                    - - 'KEYSTONE_AUTH_KEYFILE'
                      - {get_param: ContrailServiceKeyFile}
              - if:
                - internal_ipa_ca
                - - 'KEYSTONE_AUTH_INSECURE=False'
                  - list_join:
                      - '='
                      - - 'KEYSTONE_AUTH_CA_CERTFILE'
                        - {get_param: InternalTLSCAFile}
                - - 'KEYSTONE_AUTH_INSECURE=True'
          - []
      metadata_tls_env: &metadata_tls_env
        if:
          - internal_tls_enabled
          - - 'METADATA_SSL_ENABLE=True'
            - list_join:
                - '='
                - - 'METADATA_SSL_CERTFILE'
                  - {get_param: ContrailServiceCertFile}
            - list_join:
                - '='
                - - 'METADATA_SSL_KEYFILE'
                  - {get_param: ContrailServiceKeyFile}
            - list_join:
                - '='
                - - 'METADATA_SSL_CA_CERTFILE'
                  - {get_param: InternalTLSCAFile}
          - []
      contrail_common_base_env: &contrail_common_base_env
        list_concat:
          - *contrail_general_base_env
          - *contrail_tls_env
          - *contrail_auth_tls_env
          - *metadata_tls_env
      contrail_base_env: &contrail_base_env
        list_concat:
          - *contrail_auth_base_env
          - *contrail_auth_admin_env
          - null
      contrail_base_auth_internal_env: &contrail_base_auth_internal_env
        list_concat:
          - *contrail_auth_base_env
          - *contrail_auth_internal_env
          - null
      docker_config:
        step_2: {}
      contrail_common_env_file: &contrail_common_env_file
        "/etc/contrail/common_contrail.env"
      contrail_kafka_service_name: &contrail_kafka_service_name
        if: 
          - is_not_5_0
          - 'contrail_analytics_alarm'
          - 'contrail_analytics_database'
      contrail_base_env_file: &contrail_base_env_file
        - *contrail_common_env_file
      contrail_host_prep_tasks_base:
        - name: Contrail Base host prep tasks
          tags: common
          block:
            - name: register common env file
              stat:
                path: *contrail_common_env_file
              register: p
            - name: create common env file
              copy:
                dest: *contrail_common_env_file
                content: ""
              when: not p.stat.exists
            - name: set contrail base calculated parameters
              set_fact:
                contrail_base_env_params: *contrail_common_base_env
            - name: write contrail base parameters to environment file
              lineinfile:
                dest: *contrail_common_env_file
                state: present
                line: "{{ item }}"
                regexp: "^{{ item.split('=')[0] }}.*"
              with_items: "{{ contrail_base_env_params }}"

            - name: node ips (names) param name
              set_fact:
                contrail_nodes_param_name: {list_join: ["_", ["contrail_config", {get_param: contrail_nodes_param_suffux}]]}
            - name: get contrail config node ips
              shell: "hiera -c /etc/puppet/hiera.yaml {{ contrail_nodes_param_name }}"
              register: contrail_config_nodes_list
            - name: turn contrail config ips into string
              set_fact:
                contrail_config_nodes_string: "{{ contrail_config_nodes_list.stdout | from_json | join(',') }}"

            - name: node ips (names) param name
              set_fact:
                contrail_nodes_param_name: {list_join: ["_", ["contrail_database", {get_param: contrail_nodes_param_suffux}]]}
            - name: get contrail config database node ips
              shell: hiera -c /etc/puppet/hiera.yaml {{ contrail_nodes_param_name }}
              register: contrail_database_nodes_list
            - name: turn contrail config db ips into string
              set_fact:
                contrail_database_nodes_string: "{{ contrail_database_nodes_list.stdout | from_json | join(',') }}"

            - name: node ips (names) param name
              set_fact:
                contrail_nodes_param_name: {list_join: ["_", ["contrail_control", {get_param: contrail_nodes_param_suffux}]]}
            - name: get contrail control node ips
              shell: hiera -c /etc/puppet/hiera.yaml {{ contrail_nodes_param_name }}
              register: contrail_control_nodes_list
            - name: turn contrail control ips into string
              set_fact:
                contrail_control_nodes_string: "{{ contrail_control_nodes_list.stdout | from_json | join(',') }}"

            - name: node ips (names) param name
              set_fact:
                contrail_nodes_param_name: {list_join: ["_", ["contrail_analytics", {get_param: contrail_nodes_param_suffux}]]}
            - name: get contrail analytics node ips
              shell: hiera -c /etc/puppet/hiera.yaml {{ contrail_nodes_param_name }}
              register: contrail_analytics_nodes_list
            - name: turn contrail analytics ips into string
              set_fact:
                contrail_analytics_nodes_string: "{{ contrail_analytics_nodes_list.stdout | from_json | join(',') }}"

            - name: node ips (names) param name
              set_fact:
                contrail_nodes_param_name: {list_join: ["_", ["contrail_analytics_snmp", {get_param: contrail_nodes_param_suffux}]]}
            - name: get contrail analytics snmp node ips
              shell: hiera -c /etc/puppet/hiera.yaml {{ contrail_nodes_param_name }}
              register: contrail_analytics_snmp_nodes_list
            - name: turn contrail analytics snmp ips into string
              set_fact:
                contrail_analytics_snmp_nodes_string: "{{ contrail_analytics_snmp_nodes_list.stdout | from_json | join(',') }}"

            - name: node ips (names) param name
              set_fact:
                contrail_nodes_param_name: {list_join: ["_", ["contrail_analytics_alarm", {get_param: contrail_nodes_param_suffux}]]}
            - name: get contrail analytics alarm node ips
              shell: hiera -c /etc/puppet/hiera.yaml {{ contrail_nodes_param_name }}
              register: contrail_analytics_alarm_nodes_list
            - name: turn contrail analytics ips into string
              set_fact:
                contrail_analytics_alarm_nodes_string: "{{ contrail_analytics_alarm_nodes_list.stdout | from_json | join(',') }}"

            - name: node ips (names) param name
              set_fact:
                contrail_nodes_param_name: {list_join: ["_", ["contrail_analytics_database", {get_param: contrail_nodes_param_suffux}]]}
            - name: get contrail analytics database node ips
              shell: hiera -c /etc/puppet/hiera.yaml {{ contrail_nodes_param_name }}
              register: contrail_analytics_database_nodes_list
            - name: turn contrail analytics database ips into string
              set_fact:
                contrail_analytics_database_nodes_string: "{{ contrail_analytics_database_nodes_list.stdout | from_json | join(',') }}"
            - name: kafka services specific node ips param name
              set_fact:
                contrail_nodes_param_name: {list_join: ["_", [*contrail_kafka_service_name, {get_param: contrail_nodes_param_suffux}]]}
            - name: get contrail service specific node ips
              shell: "hiera -c /etc/puppet/hiera.yaml {{ contrail_nodes_param_name }}"
              register: contrail_service_nodes_list
            - name: turn contrail service specific node ips into string
              set_fact:
                contrail_kafka_service_nodes_string: "{{ contrail_service_nodes_list.stdout | from_json | join(',')  }}"
            - name: write contrail config node ips to environment file
              lineinfile:
                dest: *contrail_common_env_file
                state: present
                regexp: "^{{ item.key }}.*"
                line: "{{ item.key }}={{ item.value }}"
              with_dict:
                ANALYTICS_ALARM_ENABLE: 'True'
                ANALYTICS_SNMP_ENABLE: 'True'
                ANALYTICSDB_ENABLE: 'True'
                ANALYTICS_NODES: "{{ contrail_analytics_nodes_string }}"
                ANALYTICS_SNMP_NODES: "{{ contrail_analytics_snmp_nodes_string }}"
                ANALYTICS_ALARM_NODES: "{{ contrail_analytics_alarm_nodes_string }}"
                ANALYTICSDB_NODES: "{{ contrail_analytics_database_nodes_string }}"
                CONFIG_NODES: "{{ contrail_config_nodes_string }}"
                CONFIGDB_NODES: "{{ contrail_database_nodes_string }}"
                CONTROL_NODES: "{{ contrail_control_nodes_string }}"
                DNS_NODES: "{{ contrail_control_nodes_string }}"
                RABBITMQ_NODES: "{{ contrail_database_nodes_string }}"
                RABBITMQ_NODE_PORT: 5673
                KAFKA_NODES: "{{ contrail_kafka_service_nodes_string }}"
  # dont set zk, all services except kafka uses default zk from configdb
  #               ZOOKEEPER_NODES: "{{ contrail_database_nodes_string }}"

            # Process contrail settings as they can be Role specific and should
            # overwrite previous values if any.
            - name: get dmi
              shell: |
                #!/bin/sh
                dmidecode --s system-uuid | awk 'match($0, /[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/) { print substr($0, RSTART, RLENGTH) }'
              register: dmi
            - name: set dmi fact
              set_fact:
                dmi_uuid: "{{ dmi.stdout }}"
            - name: get contrail_settings
              shell: "hiera -c /etc/puppet/hiera.yaml contrail_settings ::uuid={{ dmi_uuid }} | sed 's/=>/:/g'"
              register: contrail_settings_string
            - name: turn contrail_settings into json
              set_fact:
                contrail_settings: "{{ contrail_settings_string.stdout | from_json }}"
              when:
                - contrail_settings_string.stdout is defined
                - contrail_settings_string.stdout != "nil"
            - name: write contrail settings to file
              lineinfile:
                dest: *contrail_common_env_file
                regexp: "^{{ item.key }}.*"
                line: "{{ item.key }}={{ item.value }}"
                state: present
              with_dict: "{{ contrail_settings }}"
              when: contrail_settings is defined



      metadata_settings: []

      fast_forward_post_upgrade_tasks_common: []

      upgrade_tasks_common:
        - name: Install docker packages on upgrade if missing
          when: step|int == 3
          tags: common
          yum:
            name: "{{ item }}"
            state: present
          with_items:
            - docker
            - python-docker-py
